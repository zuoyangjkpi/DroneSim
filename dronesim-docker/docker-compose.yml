version: '3.8'

services:
  dronesim:
    build: 
      context: .
      dockerfile: Dockerfile
    image: dronesim-ros2:latest
    container_name: dronesim-ros2-container
    hostname: dronesim-ros2
    
    # Networking
    network_mode: host
    
    # Environment variables
    environment:
      - DISPLAY=${DISPLAY}
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
      - CONDA_DEFAULT_ENV=airship_ros2
    
    # Volume mounts
    volumes:
      # X11 forwarding
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/home/dronesimuser/.Xauthority:ro
      
      # Shared folder (optional for development)
      - ./shared:/home/dronesimuser/shared:rw
      
      # Persistent data volumes
      - dronesim_workspace:/home/dronesimuser/AVIANS_ROS2_PORT1
      - dronesim_conda:/home/dronesimuser/miniconda3
    
    # Device access
    devices:
      - /dev/dri:/dev/dri  # GPU access
    
    # Port mapping (uncomment if not using host networking)
    # ports:
    #   - "11311:11311"  # ROS Master
    #   - "7400-7410:7400-7410"  # ROS2 DDS
    
    # Privileged mode (only if hardware access is required)
    privileged: false
    
    # Security options
    security_opt:
      - seccomp:unconfined
    
    # IPC settings
    ipc: host
    
    # Working directory
    working_dir: /home/dronesimuser/AVIANS_ROS2_PORT1
    
    # Keep container running interactively
    tty: true
    stdin_open: true
    
    # Restart policy
    restart: unless-stopped

# Named volumes
volumes:
  dronesim_workspace:
    driver: local
  dronesim_conda:
    driver: local

# Custom network (if not using host mode)
# networks:
#   ros_network:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 172.20.0.0/16
